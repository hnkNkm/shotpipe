# Shotpipe MVP実装計画

## 概要
スクリーンショット即送信用ミニ注釈ツール「Shotpipe」のMVP実装計画書です。
このツールは、クリップボードの画像を検知し、最小限の注釈を付けて即座に共有できることを目的としています。

## 実装フェーズ

### フェーズ1: 基盤構築とシステムトレイ
**期間目安**: 2-3日

#### 1.1 プロジェクト基盤整備
- [x] Tauri v2プロジェクトの初期設定
- [x] 必要なTauriプラグインの導入
  - [x] `tauri-plugin-clipboard-manager`
  - [x] `tauri-plugin-notification`
  - [ ] `tauri-plugin-system-tray` (組み込み機能を使用)
  - [x] `tauri-plugin-store`
- [x] Rust側の基本的なモジュール構造の構築

#### 1.2 システムトレイ実装
- [x] システムトレイアイコンの表示
- [x] メニュー構造の実装
  - [x] 監視ON/OFF切り替え
  - [x] 設定画面を開く（仮実装）
  - [x] アプリケーション終了
- [x] 状態管理（監視中/停止中）の実装

#### 1.3 クリップボード監視基盤
- `arboard`クレートを使用したクリップボード監視
- 画像データの検出ロジック
- デバウンス処理（1-2秒以内の同一画像を無視）
- 最小サイズフィルタ（64px未満を無視）
- バックグラウンドスレッドでの監視実装

### フェーズ2: 通知システムと画面遷移
**期間目安**: 2日

#### 2.1 通知システム
- OS通知の実装
  - Windows: Windows通知
  - macOS: ネイティブ通知
- 通知メッセージ: 「画像を検知しました。編集しますか？」
- 通知クリックイベントのハンドリング
- 通知のタイムアウト処理

#### 2.2 編集画面の基本構造
- 新規ウィンドウの作成と管理
- クリップボードから画像データの取得
- 画像データのBase64エンコード/デコード
- React側への画像データ受け渡し

### フェーズ3: 編集機能の実装
**期間目安**: 4-5日

#### 3.1 Canvas基盤
- React Canvas コンポーネントの作成
- 画像の適切なスケーリング表示
- Canvasのレスポンシブ対応
- マウスイベントハンドリング基盤

#### 3.2 テキスト注釈機能
- テキスト入力モードの実装
- クリック位置でのテキスト入力UI
- フォントサイズ切り替え（Small: 14px, Medium: 18px, Large: 24px）
- 色: 赤（#FF0000）固定
- テキストボックスのドラッグ移動
- Enter確定、Escキャンセルの実装

#### 3.3 矢印注釈機能
- 矢印描画モードの実装
- ドラッグによる始点→終点の指定
- 矢印の先端形状の描画
- 色: 赤（#FF0000）固定
- 線の太さ: 3px固定

#### 3.4 Undo機能
- 操作履歴の管理（配列での状態管理）
- 最低1段階のUndo実装
- Ctrl+Zでのショートカット対応

### フェーズ4: プリセットと出力処理
**期間目安**: 3日

#### 4.1 キーボードショートカット
- `react-hotkeys-hook`ライブラリの導入
- ショートカットバインディング
  - Ctrl+1: プリセット1実行
  - Ctrl+2: プリセット2実行
  - Ctrl+3: プリセット3実行
  - Esc: 編集キャンセル
- ショートカットヒントの表示UI

#### 4.2 プリセット機能
- プリセット構造の定義
  ```typescript
  interface Preset {
    name: string;
    maxWidth: number; // 0で無変更
    format: 'PNG';
    postAction: 'clipboard';
    closeAfterCopy: boolean;
  }
  ```
- デフォルトプリセット3つの設定
- 画像リサイズ処理（`image`クレート使用）

#### 4.3 クリップボード書き込み
- Canvas内容のPNG変換
- Rust側での画像処理
  - Base64デコード
  - 必要に応じてリサイズ
  - PNGエンコード
- クリップボードへの書き込み
- エラー時の元画像保護
- 完了通知の表示

### フェーズ5: 設定管理と品質改善
**期間目安**: 2-3日

#### 5.1 設定画面
- 設定画面UIの実装（React）
- プリセット編集機能
  - プリセット名の編集
  - max_widthの設定
- 監視ON/OFF切り替え
- 設定の永続化（`tauri-plugin-store`使用）

#### 5.2 品質改善
- エラーハンドリングの実装
  - クリップボード取得エラー
  - 画像処理エラー
  - メモリ不足エラー
- パフォーマンス最適化
  - 大きい画像の処理最適化
  - メモリ使用量の削減
- アプリアイコンの設定
- ビルド設定の最適化

## 技術スタック

### Rust側
- **Tauri v2**: アプリケーションフレームワーク
- **arboard**: クリップボード操作
- **image**: 画像処理
- **notify-rust**: システム通知
- **serde/serde_json**: データシリアライゼーション
- **tokio**: 非同期処理

### React側
- **React 18+**: UIフレームワーク
- **TypeScript**: 型安全性
- **Canvas API**: 画像編集
- **react-hotkeys-hook**: キーボードショートカット
- **@tauri-apps/api**: Tauri APIバインディング

### Tauriプラグイン
- **tauri-plugin-clipboard**: クリップボード操作
- **tauri-plugin-notification**: 通知
- **tauri-plugin-system-tray**: システムトレイ
- **tauri-plugin-store**: 設定の永続化

## 成果物

### MVP完成時の機能
1. ✅ クリップボード画像の自動検知
2. ✅ 通知による編集画面の起動
3. ✅ テキスト注釈の追加
4. ✅ 矢印注釈の追加
5. ✅ Undo機能（最低1段階）
6. ✅ プリセット3つ（Ctrl+1/2/3）
7. ✅ クリップボードへの出力
8. ✅ システムトレイからの制御
9. ✅ 設定の永続化

### 受け入れ基準
1. 画像コピーで通知が表示される
2. 通知クリックで編集画面が開く
3. テキスト注釈が追加できる
4. 矢印注釈が追加できる
5. Escで編集をキャンセルできる
6. Ctrl+1でクリップボードにコピーされる
7. コピー完了が通知で確認できる
8. 編集開始時にクリップボードが変更されない

## リスクと対策

### 技術的リスク
- **クリップボード API の制限**: OSごとの差異に対応
- **パフォーマンス問題**: 大きい画像の処理を最適化
- **メモリ使用量**: 適切なメモリ管理とガベージコレクション

### スケジュールリスク
- **Tauri v2の学習曲線**: 公式ドキュメントとサンプルコードの活用
- **Canvas APIの複雑性**: シンプルな実装から始める

## 次のステップ
1. フェーズ1の実装開始
2. 週次での進捗レビュー
3. 各フェーズ完了時の動作確認
4. ユーザーフィードバックの収集（可能であれば）